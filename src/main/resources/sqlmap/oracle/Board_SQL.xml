<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
	
<mapper namespace="board">
    
    <select id="selectFileGroupKey" parameterType="hashmap" resultType="string">
      SELECT SYS_GUID() FROM DUAL
    </select>
    
    <select id="getFileInfo" parameterType="hashmap" resultType="hashmap">
      SELECT * FROM MCO_FILES A
       WHERE 1=1
         <if test='GROUP_KEY != null and GROUP_KEY != "" '>         
         AND A.GROUP_KEY = #{GROUP_KEY}
         </if> 
         <if test='FILE_KEY != null and FILE_KEY != "" '>
         AND A.FILE_KEY  = #{FILE_KEY}         
         </if>
    </select>
    
    <resultMap type="hashmap" id="selectBoard">
      <result property="bno" column="bno" />
      <result property="replyCnt" column="replyCnt" />
      <result property="id" column="id" />
      <result property="title" column="title" />
      <result property="cnt" column="cnt" />
      <result property="reg_date" column="reg_date" />
      <result property="menu_nm" column="menu_nm" />
      <result property="content" column="CONTENT" jdbcType="CLOB" javaType="java.lang.String" />  

    </resultMap>

    <select id="getBoardContent" parameterType="hashmap" resultMap="selectBoard">

      SELECT bno
           , title
           , reg_date
           , cnt
           , id
           , (SELECT COUNT(B.RNO) CNT
                FROM BOARD A
                   , REPLY B
               WHERE 1=1
                 AND A.BNO = B.BNO
                 AND A.BNO = ${bno} ) AS replyCnt
           , menu_nm
           , content
        FROM BOARD A
           , MENU B
       WHERE 1=1
         AND A.KIND = B.MENU_ID
         AND bno = #{bno}

    </select>
    
    <select id="getBoardList" parameterType="hashmap" resultType="hashmap">
        
      SELECT A.BNO      AS bno
           , A.TITLE    AS title
           , A.ID       AS id
           , A.REG_DATE AS reg_date
           , A.CNT      AS cnt
           , C.CNT      AS good
           , B.CNT      AS replyCnt
        FROM BOARD A
           , (SELECT A.BNO BNO
                   , COUNT(B.RNO) CNT
                FROM BOARD A
                   , REPLY B
               WHERE 1=1
                 AND A.BNO = B.BNO (+)
            GROUP BY A.BNO) B
           , (SELECT B.BNO BNO
                   , COUNT(A.ID) CNT
                FROM GOOD A
                   , BOARD B
               WHERE 1=1
                 AND B.BNO = A.BNO (+)
            GROUP BY B.BNO) C
       WHERE 1=1
         AND A.BNO = B.BNO
         AND A.BNO = C.BNO
    ORDER BY A.BNO DESC
    </select>
    
    <insert id="insertPost" parameterType="hashmap">
<!--       INSERT INTO BOARD ( BNO -->
<!--                         , UPD_SEQ -->
<!--                         , ID -->
<!--                         , TITLE -->
<!--                         , REG_DATE -->
<!--                         , CONTENT -->
<!--                         , TYPE -->
<!--                         , CNT -->
<!--                         , GRP_KEY -->
<!--                         , KIND ) -->
<!--                  VALUES ( SEQ_BOARD.NEXTVAL -->
<!--                         , 0 -->
<!--                         , #{id} -->
<!--                         , #{title} -->
<!--                         , SYSDATE -->
<!--                         , #{content} -->
<!--                         , #{type} -->
<!--                         , 0 -->
<!--                         , SYS_GUID() -->
<!--                         , #{kind} ) -->
                        
      { CALL INSERT_BOARD ( #{id, mode=IN, jdbcType=VARCHAR}
                          , #{title, mode=IN, jdbcType=VARCHAR}
                          , #{content, mode=IN, jdbcType=VARCHAR}
                          , #{type, mode=IN, jdbcType=VARCHAR}
                          , #{kind, mode=IN, jdbcType=VARCHAR} )
      }
                            
      
    </insert>
    
    <insert id="insertFileInfo">
      INSERT INTO MCO_FILES ( GROUP_KEY
                            , FILE_KEY
                            , FILE_REALNAME
                            , FILE_NAME
                            , FILE_PATH
                            , FILE_LENGTH
                            , FILE_TYPE
                            , DEL_YN
                            , REG_ID
                            , REG_DATE
                            , CHG_ID
                            , CHG_DATE)
                     VALUES ( #{GROUP_KEY}
                            , #{FILE_KEY}
                            , #{FILE_REALNAME}
                            , #{FILE_NAME}
                            , #{FILE_PATH}
                            , #{FILE_LENGTH}
                            , #{FILE_TYPE}
                            , 'N'
                            , #{USER_ID}
                            , SYSDATE
                            , #{USER_ID}
                            , SYSDATE)
    </insert>
</mapper>
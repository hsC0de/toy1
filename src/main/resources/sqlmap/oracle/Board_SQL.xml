<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
	
<mapper namespace="board">
    
    <select id="selectFileGroupKey" parameterType="hashmap" resultType="string">
      SELECT SYS_GUID() FROM DUAL
    </select>
    
    <select id="getFileInfo" parameterType="hashmap" resultType="hashmap">
      SELECT * FROM MCO_FILES A
       WHERE 1=1
         <if test='GROUP_KEY != null and GROUP_KEY != "" '>         
         AND A.GROUP_KEY = #{GROUP_KEY}
         </if> 
         <if test='FILE_KEY != null and FILE_KEY != "" '>
         AND A.FILE_KEY  = #{FILE_KEY}         
         </if>
    </select>
    
    <resultMap type="hashmap" id="selectBoard">
      <result property="bno" column="BNO" />
      <result property="preContent" column="PRECONTENT" />
      <result property="nextContent" column="NEXTCONTENT" />
      <result property="replyCnt" column="REPLYCNT" />
      <result property="id" column="ID" jdbcType="VARCHAR" javaType="java.lang.String"/>
      <result property="title" column="TITLE" jdbcType="VARCHAR" javaType="java.lang.String"/>
      <result property="cnt" column="CNT" />
      <result property="reg_date" column="REG_DATE" jdbcType="VARCHAR" javaType="java.lang.String"/>
      <result property="menu_nm" column="MENU_NM" jdbcType="VARCHAR" javaType="java.lang.String"/>
      <result property="content" column="CONTENT" jdbcType="VARCHAR" javaType="java.lang.String" />  

    </resultMap>

    <select id="getBoardContent" parameterType="hashmap" resultMap="selectBoard">

      SELECT BNO
           , (SELECT BNO FROM BOARD WHERE BNO &gt; #{bno} ORDER BY BNO LIMIT 1) AS PRECONTENT
           , (SELECT BNO FROM BOARD WHERE BNO &lt; #{bno} ORDER BY BNO DESC LIMIT 1) AS NEXTCONTENT
           , TITLE
           , REG_DATE
           , CNT
           , ID
           , (SELECT COUNT(B.RNO) AS CNT
                FROM BOARD A
                   , REPLY B
               WHERE 1=1
                 AND A.BNO = B.BNO
                 AND A.BNO = #{bno} ) AS REPLYCNT
           , MENU_NM
           , CONTENT
        FROM BOARD AS A
        JOIN MENU AS B
          ON A.KIND = B.MENU_ID
       WHERE 1=1
         AND bno = #{bno}

    </select>
    
    <resultMap type="hashmap" id="getBoardListMap">
      <result property="bno" column="BNO" />
      <result property="replyCnt" column="REPLYCNT" />
      <result property="id" column="ID" jdbcType="VARCHAR" javaType="java.lang.String"/>
      <result property="title" column="TITLE" jdbcType="VARCHAR" javaType="java.lang.String"/>
      <result property="cnt" column="CNT" />
      <result property="reg_date" column="REG_DATE" jdbcType="VARCHAR" javaType="java.lang.String"/>
      <result property="good" column="GOOD" /> 
      <result property="gap" column="GAP"/>
    </resultMap>
    
    <select id="getBoardList" parameterType="hashmap" resultMap="getBoardListMap">
        
      SELECT A.BNO      AS BNO
           , A.TITLE    AS TITLE
           , A.ID       AS ID
           , UNIX_TIMESTAMP(DATE_FORMAT(NOW(), '%Y-%m-%d')) - UNIX_TIMESTAMP(A.REG_DATE) AS GAP
           , A.REG_DATE AS REG_DATE
           , A.CNT      AS CNT
           , C.CNT      AS GOOD
           , B.CNT      AS REPLYCNT
        FROM BOARD AS A
        JOIN (SELECT A.BNO AS BNO
                   , COUNT(B.RNO) AS CNT
                FROM BOARD AS A
     LEFT OUTER JOIN REPLY AS B
                  ON A.BNO = B.BNO
               WHERE 1=1
            GROUP BY A.BNO) AS B
          ON A.BNO = B.BNO
        JOIN (SELECT A.BNO AS BNO
                   , COUNT(B.ID) AS CNT
                FROM BOARD AS A
     LEFT OUTER JOIN GOOD AS B
                  ON A.BNO = B.BNO
               WHERE 1=1
            GROUP BY A.BNO) AS C
          ON A.BNO = C.BNO
       WHERE 1=1
    ORDER BY A.BNO DESC 
       LIMIT #{offset}, #{userDisplay}
    </select>
    
    <select id="getTotal" resultType="int">
      SELECT COUNT(*) AS TOTAL
        FROM BOARD
       WHERE 1=1
    </select>
    
    <insert id="insertPost" parameterType="hashmap">
      INSERT INTO BOARD ( UPD_SEQ
                        , ID
                        , TITLE
                        , REG_DATE
                        , CONTENT
                        , TYPE
                        , CNT
                        , GRP_KEY
                        , KIND )
                 VALUES ( 0
                        , #{id}
                        , #{title}
                        , NOW(3)
                        , #{content}
                        , #{type}
                        , 0
                        , NULL
                        , #{kind} )
                        
<!--       { CALL INSERT_BOARD ( #{id, mode=IN, jdbcType=VARCHAR} -->
<!--                           , #{title, mode=IN, jdbcType=VARCHAR} -->
<!--                           , #{content, mode=IN, jdbcType=VARCHAR} -->
<!--                           , #{type, mode=IN, jdbcType=VARCHAR} -->
<!--                           , #{kind, mode=IN, jdbcType=VARCHAR} ) -->
<!--       } -->
    </insert>
    
    <insert id="insertFileInfo">
      INSERT INTO MCO_FILES ( GROUP_KEY
                            , FILE_KEY
                            , FILE_REALNAME
                            , FILE_NAME
                            , FILE_PATH
                            , FILE_LENGTH
                            , FILE_TYPE
                            , DEL_YN
                            , REG_ID
                            , REG_DATE
                            , CHG_ID
                            , CHG_DATE)
                     VALUES ( #{GROUP_KEY}
                            , #{FILE_KEY}
                            , #{FILE_REALNAME}
                            , #{FILE_NAME}
                            , #{FILE_PATH}
                            , #{FILE_LENGTH}
                            , #{FILE_TYPE}
                            , 'N'
                            , #{USER_ID}
                            , SYSDATE
                            , #{USER_ID}
                            , SYSDATE)
    </insert>
</mapper>